#!/bin/bash

set -e
set -o pipefail

usage() {
  echo "Usage: git-autosave <command> [options]"
  echo ""
  echo "Commands:"
  echo "  start               Start watching the current directory for changes"
  echo "  list                List all autosaved states"
  echo "  show <hash>         Show the diff of the given autosaved state and HEAD"
  echo "  restore <hash>      Resets HEAD to the given state"
  echo "  save-working-dir    Save the current working directory's state"

  exit 1
}

start() {
  echo "Watching for changes..."

  fswatch -0 -e "\.git" . | xargs -0 -n 1 "git-autosave" "save-working-dir"
}

save_working_dir() {
  local tree_hash
  local parent
  local message
  local commit_hash

  echo "Saving working dir"

  # Create tree
  tree_hash=$(write_tree ".")

  # Create commit
  parent=$(git show-ref --hash refs/autosave || true)
  message="Autosave $(date)"
  commit_hash=$(git commit-tree ${parent:+ -p "$parent"} -m "$message" "$tree_hash")

  # Create ref
  git update-ref "refs/autosave" "$commit_hash"
}

list() {
  git log --pretty=short -p autosave
}

show() {
  local hash="$1"

  if [ ! "$hash" ]; then
    usage
  fi

  git diff "HEAD..$hash"
}

restore() {
  local hash="$1"
  local patch

  if [ ! "$hash" ]; then
    usage
  fi

  patch=$(git diff-tree -p "HEAD..$hash")
  git apply <(echo "$patch")
}

write_tree() {
  local dir="$1"
  local tree=""
  local filename
  local file
  local hash

  for file in $dir/*; do
    filename=$(basename "$file")

    if [ -f "$file" ]; then
      hash=$(git hash-object -w -- "$file")
      # TODO set correct mode
      tree="${tree}100644 blob $hash\t$filename\n"
    elif [ -d "$file" ]; then
      write_tree "$file" 1>/dev/null
    fi
  done

  printf "%b" "$tree" | git mktree
}

if [ $# = 0 ]; then
  usage
fi

cmdname="$1"
shift

#while [[ $# -gt 0 ]]; do
#  key="$1"
#  case "$key" in
#    -s|--searchpath)
#      shift
#      shift
#      ;;
#    *)
#      usage
#      ;;
#  esac
#done

case "$cmdname" in
  start)
    start
    ;;
  list)
    list
    ;;
  show)
    show "$@"
    ;;
  restore)
    restore "$@"
    ;;
  save-working-dir)
    save_working_dir
    ;;
  *)
    usage
    ;;
esac
